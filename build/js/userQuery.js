window;import{jsxs as e,jsx as n,Fragment as t}from"react/jsx-runtime";import*as r from"react";import{RpcContext as a,useAsyncPersistent as o,mapRpcError as i,importWidgetModule as s,EditorContext as c,InteractiveMessageData as u}from"@leanprover/infoview";var l=function(){return l=Object.assign||function(e){for(var n,t=1,r=arguments.length;t<r;t++)for(var a in n=arguments[t])Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a]);return e},l.apply(this,arguments)};function f(e,n,t,r){return new(t||(t=Promise))((function(a,o){function i(e){try{c(r.next(e))}catch(e){o(e)}}function s(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var n;e.done?a(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(i,s)}c((r=r.apply(e,n||[])).next())}))}function p(e,n){var t,r,a,o,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(s){return function(c){return function(s){if(t)throw new TypeError("Generator is already executing.");for(;o&&(o=0,s[0]&&(i=0)),i;)try{if(t=1,r&&(a=2&s[0]?r.return:s[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,s[1])).done)return a;switch(r=0,a&&(s=[2&s[0],a.value]),s[0]){case 0:case 1:a=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,r=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!(a=i.trys,(a=a.length>0&&a[a.length-1])||6!==s[0]&&2!==s[0])){i=0;continue}if(3===s[0]&&(!a||s[1]>a[0]&&s[1]<a[3])){i.label=s[1];break}if(6===s[0]&&i.label<a[1]){i.label=a[1],a=s;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(s);break}a[2]&&i.ops.pop(),i.trys.pop();continue}s=n.call(e,i)}catch(e){s=[6,e],r=0}finally{t=a=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}}function h(a,o,i){return f(this,void 0,void 0,(function(){var c,u,d,m,v,w,g,b,y,x,k,E,q,C,S,T,j,D=this;return p(this,(function(N){switch(N.label){case 0:return"text"in i?[2,n(t,{children:i.text})]:[3,1];case 1:if(!("element"in i))return[3,3];for(c=i.element,u=c[0],d=c[1],C=c[2],m={},v=0,w=d;v<w.length;v++)g=w[v],b=g[0],y=g[1],m[b]=y;return[4,Promise.all(C.map((function(e){return f(D,void 0,void 0,(function(){return p(this,(function(n){switch(n.label){case 0:return[4,h(a,o,e)];case 1:return[2,n.sent()]}}))}))})))];case 2:return S=N.sent(),"hr"===u?[2,n("hr",{})]:0===S.length?[2,r.createElement(u,m)]:[2,r.createElement(u,m,S)];case 3:return"component"in i?(x=i.component,k=x[0],E=x[1],q=x[2],C=x[3],[4,Promise.all(C.map((function(e){return f(D,void 0,void 0,(function(){return p(this,(function(n){switch(n.label){case 0:return[4,h(a,o,e)];case 1:return[2,n.sent()]}}))}))})))]):[3,6];case 4:return S=N.sent(),T=l(l({},q),{pos:o}),[4,s(a,o,k)];case 5:if(j=N.sent(),!(E in j))throw new Error("Module '".concat(k,"' does not export '").concat(E,"'"));return 0===S.length?[2,r.createElement(j[E],T)]:[2,r.createElement(j[E],T,S)];case 6:return[2,e("span",l({className:"red"},{children:["Unknown HTML variant: ",JSON.stringify(i)]}))];case 7:return[2]}}))}))}function d(s){var c=s.pos,u=s.html,f=r.useContext(a),p=o((function(){return h(f,c,u)}),[f,c,u]);return"resolved"===p.state?p.value:"rejected"===p.state?e("span",l({className:"red"},{children:["Error rendering HTML: ",i(p.error).message]})):n(t,{})}function m(e){return n("div",{children:n("p",{children:"No questions..."})})}function v(e){var t=r.useRef(null);return r.useEffect((function(){null!==t.current&&t.current.reset()}),[e.q.elems]),n("form",l({onSubmit:function(n){n.preventDefault();var t=new FormData(n.currentTarget);e.answer(Object.fromEntries(t))},ref:t},{children:e.q.elems.map((function(t){return n(d,{pos:e.pos,html:t})}))}))}function w(e,n){if(!("element"in e))return e;var t=e.element,r=t[0],a=t[1],o=t[2];if("button"==r||"a"==r){var i=a.slice();return"a"==r&&i.push(["className","pointer dim"]),i.push(["onClick",n]),{element:[r,i,o]}}return{element:[r,a,o.map((function(e){return w(e,n)}))]}}function g(e){return n(d,{html:w(e.html,e.onClick),pos:e.pos})}function b(t){var a=r.useRef(null);return e("div",{children:[n(d,{pos:t.pos,html:t.q.question}),n("div",l({ref:a},{children:t.q.options.map((function(e,r){return n(g,{html:e,pos:t.pos,onClick:function(){return t.answer(r)}})}))}))]})}function y(e){return n(d,{pos:e.pos,html:e.q.code})}"function"==typeof SuppressedError&&SuppressedError;var x={kind:"empty"};function k(t){var o=r.useState([x,null]),i=o[0],s=o[1],h=r.useRef([]),d=i[0],w=i[1],g=r.useContext(a),k=r.useContext(c);function E(e){return f(this,void 0,void 0,(function(){var n,t,r;return p(this,(function(a){switch(a.label){case 0:return n=e[0],t=e[1],"editDocument"!=n.kind?[3,3]:(r=n.edit,h.current.length>0&&h.current[h.current.length-1].edits.push(r),[4,k.api.applyEdit({documentChanges:[r]})]);case 1:return a.sent(),[4,g.call("processUserAnswer",[null,t])];case 2:return e=a.sent(),[3,4];case 3:return s([n,t]),[3,5];case 4:return[3,0];case 5:return[2]}}))}))}function q(e){return f(this,void 0,void 0,(function(){var n;return p(this,(function(t){switch(t.label){case 0:return[4,g.call("processUserAnswer",[e,w])];case 1:return n=t.sent(),h.current.push({state:i,edits:[]}),E(n),[2]}}))}))}function C(e){var n=e.newText.split("\n"),t=e.range.start.line+(n.length-1),r=n[n.length-1].length;1==n.length&&(r+=e.range.start.character);var a="";a=e.range.start.line==e.range.end.line?" ".repeat(e.range.end.character-e.range.start.character):"\n".repeat(e.range.end.line-e.range.start.line)+" ".repeat(e.range.end.character);var o={range:{start:e.range.start,end:{line:t,character:r}},newText:a};return console.log(o),o}r.useEffect((function(){!function(){f(this,void 0,void 0,(function(){var e;return p(this,(function(n){switch(n.label){case 0:return[4,g.call("initializeInteraction",t.code)];case 1:return e=n.sent(),h.current=[],E(e),[2]}}))}))}()}),[t.pos.line]);var S=n("div",{});switch(d.kind){case"empty":S=n(m,{q:{},answer:q,pos:t.pos});break;case"form":S=n(v,{q:d,answer:q,pos:t.pos});break;case"select":S=n(b,{q:d,answer:q,pos:t.pos});break;case"custom":S=n(y,{q:d,answer:q,pos:t.pos});break;case"error":S=n(u,{msg:d.data})}return e("div",{children:[n("button",l({onClick:function(){console.log(h);var e=h.current.pop();void 0!==e&&(E(e.state),function(e){f(this,void 0,void 0,(function(){var n,t,r;return p(this,(function(a){switch(a.label){case 0:n=e.length-1,a.label=1;case 1:return n>=0?(t=e[n],r={textDocument:t.textDocument,edits:t.edits.map(C)},[4,k.api.applyEdit({documentChanges:[r]})]):[3,4];case 2:a.sent(),a.label=3;case 3:return n--,[3,1];case 4:return[2]}}))}))}(e.edits))}},{children:"Undo"})),n("hr",{}),S]})}export{k as default};
window;import{jsxs as e,jsx as n,Fragment as t}from"react/jsx-runtime";import*as r from"react";import{RpcContext as i,useAsyncPersistent as o,mapRpcError as s,importWidgetModule as c,EditorContext as l}from"@leanprover/infoview";async function a(i,o,s){if("text"in s)return n(t,{children:s.text});if("element"in s){const[e,t,c]=s.element,l={};for(const[e,n]of t)l[e]=n;const u=await Promise.all(c.map((async e=>await a(i,o,e))));return"hr"===e?n("hr",{}):0===u.length?r.createElement(e,l):r.createElement(e,l,u)}if("component"in s){const[e,n,t,l]=s.component,u=await Promise.all(l.map((async e=>await a(i,o,e)))),d={...t,pos:o},f=await c(i,o,e);if(!(n in f))throw new Error(`Module '${e}' does not export '${n}'`);return 0===u.length?r.createElement(f[n],d):r.createElement(f[n],d,u)}return e("span",{className:"red",children:["Unknown HTML variant: ",JSON.stringify(s)]})}function u({pos:c,html:l}){const u=r.useContext(i),d=o((()=>a(u,c,l)),[u,c,l]);return"resolved"===d.state?d.value:"rejected"===d.state?e("span",{className:"red",children:["Error rendering HTML: ",s(d.error).message]}):n(t,{})}const d=r.createContext({answer:function(e){console.warn(`Uncaptured answer: ${e}`)},pos:{uri:"dummy",line:0,character:0}});function f(e){return n("div",{children:n("p",{children:"No questions..."})})}function p(e){const t=r.useContext(d);const i=r.useRef(null);return r.useEffect((()=>{null!==i.current&&i.current.reset()}),[e.elems]),n("form",{onSubmit:function(e){e.preventDefault();const n=new FormData(e.currentTarget);t.answer(Object.fromEntries(n))},ref:i,children:e.elems.map((e=>n(u,{pos:t.pos,html:e})))})}function m(e,n){if(!("element"in e))return e;const[t,r,i]=e.element;if("button"==t||"a"==t){const e=r.slice();return"a"==t&&e.push(["className","pointer dim"]),e.push(["onClick",n]),{element:[t,e,i]}}return{element:[t,r,i.map((e=>m(e,n)))]}}function h(e){return n(u,{html:m(e.html,e.onClick),pos:e.pos})}function w(t){const i=r.useRef(null),o=r.useContext(d);return e("div",{children:[n(u,{pos:o.pos,html:t.question}),n("div",{ref:i,children:t.options.map(((e,t)=>n(h,{html:e,pos:o.pos,onClick:()=>o.answer(t)})))})]})}const v={level:0,editPos:{line:0,character:0},widget:n("p",{children:"Initializing..."})};function g(t){const[o,s]=r.useState(v),c=r.useContext(i),a=r.useContext(l),f=r.useRef({line:0,character:0}),p=r.useRef(null);function m(e,n){if(null===p.current)return void(n.length>0&&(console.warn("Document editing not initialized, cannot insert:"),console.warn(n)));if(e===f.current&&0==n.length)return;const t={start:e,end:f.current};var r=n.map((e=>e+"\n")).join("");0==n.length?f.current=e:f.current={line:e.line+n.length,character:0},0!=e.character&&(r="\n"+r,f.current={line:f.current.line+1,character:0}),async function(e){await a.api.applyEdit({documentChanges:[e]})}({textDocument:p.current.ident,edits:[{range:t,newText:r}]})}function h(e,r,i,o){const l=f.current;const a=n(d.Provider,{value:{answer:async function(e){console.log("Answer:"),console.log(e);var n=o;const t=[];for(;;){const r=await c.call("processUserAnswer",[e,n]),i=r[0];if(n=r[1],e=null,"insertLine"in i)t.push(i.insertLine.line);else{if(!("initEdit"in i)){m(l,t),s(h(w,i.widget.level,i.widget.w,n));break}console.warn("initEdit is only available suring initialization")}}},pos:t.pos},children:n(u,{html:i,pos:t.pos})});for(var p=e;void 0!==p&&p.level>=r;)p=p.parent;const w={level:r,widget:a,editPos:l,parent:p,previous:e};return w}r.useEffect((()=>{!async function(){var[e,n]=await c.call("initializeInteraction",t.code);for(p.current=null;;){if("insertLine"in e)console.warn("Edits disabled before user action");else{if(!("initEdit"in e)){p.current&&(f.current=p.current.startPos),s(h(void 0,e.widget.level,e.widget.w,n));break}p.current=e.initEdit}[e,n]=await c.call("processUserAnswer",[null,n])}}()}),[t.pos.line]);const w=[];for(var g=o;void 0!==g;)w.push(g.widget),g=g.parent;return w.reverse(),e("div",{children:[n("button",{onClick:function(){console.log("Undo"),console.log(o),void 0!==o.previous&&(m(o.previous.editPos,[]),s(o.previous))},children:"Undo"}),n("hr",{}),w]})}export{f as EmptyWidget,p as FormWidget,w as SelectWidget,g as default};
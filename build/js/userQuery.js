window;import{jsxs as e,jsx as n,Fragment as t}from"react/jsx-runtime";import*as r from"react";import{RpcContext as a,useAsyncPersistent as s,mapRpcError as o,importWidgetModule as c,EditorContext as i,InteractiveMessageData as l}from"@leanprover/infoview";async function u(a,s,o){if("text"in o)return n(t,{children:o.text});if("element"in o){const[e,t,c]=o.element,i={};for(const[e,n]of t)i[e]=n;const l=await Promise.all(c.map((async e=>await u(a,s,e))));return"hr"===e?n("hr",{}):0===l.length?r.createElement(e,i):r.createElement(e,i,l)}if("component"in o){const[e,n,t,i]=o.component,l=await Promise.all(i.map((async e=>await u(a,s,e)))),p={...t,pos:s},m=await c(a,s,e);if(!(n in m))throw new Error(`Module '${e}' does not export '${n}'`);return 0===l.length?r.createElement(m[n],p):r.createElement(m[n],p,l)}return e("span",{className:"red",children:["Unknown HTML variant: ",JSON.stringify(o)]})}function p({pos:c,html:i}){const l=r.useContext(a),p=s((()=>u(l,c,i)),[l,c,i]);return"resolved"===p.state?p.value:"rejected"===p.state?e("span",{className:"red",children:["Error rendering HTML: ",o(p.error).message]}):n(t,{})}function m(e){return n("div",{children:n("p",{children:"No questions..."})})}function d(e){const t=r.useRef(null);return r.useEffect((()=>{null!==t.current&&t.current.reset()}),[e.q.elems]),n("form",{onSubmit:function(n){n.preventDefault();const t=new FormData(n.currentTarget);e.answer(Object.fromEntries(t))},ref:t,children:e.q.elems.map((t=>n(p,{pos:e.pos,html:t})))})}function f(e,n){if(!("element"in e))return e;const[t,r,a]=e.element;if("button"==t||"a"==t){const e=r.slice();return"a"==t&&e.push(["className","pointer dim"]),e.push(["onClick",n]),{element:[t,e,a]}}return{element:[t,r,a.map((e=>f(e,n)))]}}function h(e){return n(p,{html:f(e.html,e.onClick),pos:e.pos})}function g(t){const a=r.useRef(null);return e("div",{children:[n(p,{pos:t.pos,html:t.q.question}),n("div",{ref:a,children:t.q.options.map(((e,r)=>n(h,{html:e,pos:t.pos,onClick:()=>t.answer(r)})))})]})}function w(e){return n(p,{pos:e.pos,html:e.q.code})}const v={kind:"empty"};function k(t){const[s,o]=r.useState([v,null]),c=r.useRef([]),[u,p]=s,f=r.useContext(a),h=r.useContext(i);async function k(e){for(;;){const[n,t]=e;if("editDocument"!=n.kind){o([n,t]);break}{const r=n.edit;if(c.current.length>0){c.current[c.current.length-1].edits.push(r)}await h.api.applyEdit({documentChanges:[r]}),e=await f.call("processUserAnswer",[null,t])}}}async function x(e){const n=await f.call("processUserAnswer",[e,p]);c.current.push({state:s,edits:[]}),k(n)}function y(e){const n=e.newText.split("\n"),t=e.range.start.line+(n.length-1);var r=n[n.length-1].length;1==n.length&&(r+=e.range.start.character);var a="";a=e.range.start.line==e.range.end.line?" ".repeat(e.range.end.character-e.range.start.character):"\n".repeat(e.range.end.line-e.range.start.line)+" ".repeat(e.range.end.character);const s={range:{start:e.range.start,end:{line:t,character:r}},newText:a};return console.log(s),s}r.useEffect((()=>{!async function(){const e=await f.call("initializeInteraction",t.code);c.current=[],k(e)}()}),[t.pos.line]);var q=n("div",{});switch(u.kind){case"empty":q=n(m,{q:{},answer:x,pos:t.pos});break;case"form":q=n(d,{q:u,answer:x,pos:t.pos});break;case"select":q=n(g,{q:u,answer:x,pos:t.pos});break;case"custom":q=n(w,{q:u,answer:x,pos:t.pos});break;case"error":q=n(l,{msg:u.data})}return e("div",{children:[n("button",{onClick:function(){console.log(c);const e=c.current.pop();void 0!==e&&(k(e.state),async function(e){for(var n=e.length-1;n>=0;n--){const t=e[n],r={textDocument:t.textDocument,edits:t.edits.map(y)};await h.api.applyEdit({documentChanges:[r]})}}(e.edits))},children:"Undo"}),n("hr",{}),q]})}export{k as default};